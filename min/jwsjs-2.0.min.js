if(typeof KJUR=="undefined"||!KJUR)KJUR={};if(typeof KJUR.jws=="undefined"||!KJUR.jws)KJUR.jws={};KJUR.jws.JWSJS=function(){var _KJUR=KJUR,_KJUR_jws=_KJUR.jws,_KJUR_jws_JWS=_KJUR_jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString;this.aHeader=[];this.sPayload="";this.aSignature=[];this.init=function(){this.aHeader=[];this.sPayload=undefined;this.aSignature=[]};this.initWithJWS=function(sJWS){this.init();var a=sJWS.split(".");if(a.length!=3)throw"malformed input JWS";this.aHeader.push(a[0]);this.sPayload=a[1];this.aSignature.push(a[2])};this.addSignature=function(alg,spHead,key,pass){if(this.sPayload===undefined||this.sPayload===null)throw"there's no JSON-JS signature to add.";var sigLen=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var sJWS=KJUR.jws.JWS.sign(alg,spHead,this.sPayload,key,pass);var a=sJWS.split(".");var sHeader2=a[0];var sSignature2=a[2];this.aHeader.push(a[0]);this.aSignature.push(a[2])}catch(ex){if(this.aHeader.length>sigLen)this.aHeader.pop();if(this.aSignature.length>sigLen)this.aSignature.pop();throw"addSignature failed: "+ex}};this.verifyAll=function(aKeyAlg){if(this.aHeader.length!==aKeyAlg.length||this.aSignature.length!==aKeyAlg.length)return false;for(var i=0;i<aKeyAlg.length;i++){var keyAlg=aKeyAlg[i];if(keyAlg.length!==2)return false;var result=this.verifyNth(i,keyAlg[0],keyAlg[1]);if(result===false)return false}return true};this.verifyNth=function(idx,key,acceptAlgs){if(this.aHeader.length<=idx||this.aSignature.length<=idx)return false;var sHeader=this.aHeader[idx];var sSignature=this.aSignature[idx];var sJWS=sHeader+"."+this.sPayload+"."+sSignature;var result=false;try{result=_KJUR_jws_JWS.verify(sJWS,key,acceptAlgs)}catch(ex){return false}return result};this.readJWSJS=function(spJWSJS){if(typeof spJWSJS==="string"){var oJWSJS=_readSafeJSONString(spJWSJS);if(oJWSJS==null)throw"argument is not safe JSON object string";this.aHeader=oJWSJS.headers;this.sPayload=oJWSJS.payload;this.aSignature=oJWSJS.signatures}else{try{if(spJWSJS.headers.length>0){this.aHeader=spJWSJS.headers}else{throw"malformed header"}if(typeof spJWSJS.payload==="string"){this.sPayload=spJWSJS.payload}else{throw"malformed signatures"}if(spJWSJS.signatures.length>0){this.aSignatures=spJWSJS.signatures}else{throw"malformed signatures"}}catch(ex){throw"malformed JWS-JS JSON object: "+ex}}};this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}};this.isEmpty=function(){if(this.aHeader.length==0)return 1;return 0}};