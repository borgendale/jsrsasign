if(typeof KJUR=="undefined"||!KJUR)KJUR={};if(typeof KJUR.jws=="undefined"||!KJUR.jws)KJUR.jws={};KJUR.jws.JWS=function(){var _KJUR=KJUR,_KJUR_jws_JWS=_KJUR.jws.JWS,_isSafeJSONString=_KJUR_jws_JWS.isSafeJSONString;this.parseJWS=function(sJWS,sigValNotNeeded){if(this.parsedJWS!==undefined&&(sigValNotNeeded||this.parsedJWS.sigvalH!==undefined)){return}var matchResult=sJWS.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(matchResult==null){throw"JWS signature is not a form of 'Head.Payload.SigValue'."}var b6Head=matchResult[1];var b6Payload=matchResult[2];var b6SigVal=matchResult[3];var sSI=b6Head+"."+b6Payload;this.parsedJWS={};this.parsedJWS.headB64U=b6Head;this.parsedJWS.payloadB64U=b6Payload;this.parsedJWS.sigvalB64U=b6SigVal;this.parsedJWS.si=sSI;if(!sigValNotNeeded){var hSigVal=b64utohex(b6SigVal);var biSigVal=parseBigInt(hSigVal,16);this.parsedJWS.sigvalH=hSigVal;this.parsedJWS.sigvalBI=biSigVal}var sHead=b64utoutf8(b6Head);var sPayload=b64utoutf8(b6Payload);this.parsedJWS.headS=sHead;this.parsedJWS.payloadS=sPayload;if(!_isSafeJSONString(sHead,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+sHead}};KJUR.jws.JWS.sign=function(alg,spHeader,spPayload,key,pass){var _KJUR=KJUR,_KJUR_jws=_KJUR.jws,_KJUR_jws_JWS=_KJUR_jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_isSafeJSONString=_KJUR_jws_JWS.isSafeJSONString,_KJUR_crypto=_KJUR.crypto,_ECDSA=_KJUR_crypto.ECDSA,_Mac=_KJUR_crypto.Mac,_Signature=_KJUR_crypto.Signature,_JSON=JSON;var sHeader,pHeader,sPayload;if(typeof spHeader!="string"&&typeof spHeader!="object")throw"spHeader must be JSON string or object: "+spHeader;if(typeof spHeader=="object"){pHeader=spHeader;sHeader=_JSON.stringify(pHeader)}if(typeof spHeader=="string"){sHeader=spHeader;if(!_isSafeJSONString(sHeader))throw"JWS Head is not safe JSON string: "+sHeader;pHeader=_readSafeJSONString(sHeader)}sPayload=spPayload;if(typeof spPayload=="object")sPayload=_JSON.stringify(spPayload);if((alg==""||alg==null)&&pHeader["alg"]!==undefined){alg=pHeader["alg"]}if(alg!=""&&alg!=null&&pHeader["alg"]===undefined){pHeader["alg"]=alg;sHeader=_JSON.stringify(pHeader)}if(alg!==pHeader.alg)throw"alg and sHeader.alg doesn't match: "+alg+"!="+pHeader.alg;var sigAlg=null;if(_KJUR_jws_JWS.jwsalg2sigalg[alg]===undefined){throw"unsupported alg name: "+alg}else{sigAlg=_KJUR_jws_JWS.jwsalg2sigalg[alg]}var uHeader=utf8tob64u(sHeader);var uPayload=utf8tob64u(sPayload);var uSignatureInput=uHeader+"."+uPayload;var hSig="";if(sigAlg.substr(0,4)=="Hmac"){if(key===undefined)throw"mac key shall be specified for HS* alg";var mac=new _Mac({alg:sigAlg,prov:"cryptojs",pass:key});mac.updateString(uSignatureInput);hSig=mac.doFinal()}else if(sigAlg.indexOf("withECDSA")!=-1){var sig=new _Signature({alg:sigAlg});sig.init(key,pass);sig.updateString(uSignatureInput);hASN1Sig=sig.sign();hSig=KJUR.crypto.ECDSA.asn1SigToConcatSig(hASN1Sig)}else if(sigAlg!="none"){var sig=new _Signature({alg:sigAlg});sig.init(key,pass);sig.updateString(uSignatureInput);hSig=sig.sign()}var uSig=hextob64u(hSig);return uSignatureInput+"."+uSig};KJUR.jws.JWS.verify=function(sJWS,key,acceptAlgs){var _KJUR=KJUR,_KJUR_jws=_KJUR.jws,_KJUR_jws_JWS=_KJUR_jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_KJUR_crypto=_KJUR.crypto,_ECDSA=_KJUR_crypto.ECDSA,_Mac=_KJUR_crypto.Mac,_Signature=_KJUR_crypto.Signature,_RSAKey;if(typeof RSAKey!==undefined)_RSAKey=RSAKey;var a=sJWS.split(".");if(a.length!==3)return false;var uHeader=a[0];var uPayload=a[1];var uSignatureInput=uHeader+"."+uPayload;var hSig=b64utohex(a[2]);var pHeader=_readSafeJSONString(b64utoutf8(a[0]));var alg=null;var algType=null;if(pHeader.alg===undefined){throw"algorithm not specified in header"}else{alg=pHeader.alg;algType=alg.substr(0,2)}if(acceptAlgs!=null&&Object.prototype.toString.call(acceptAlgs)==="[object Array]"&&acceptAlgs.length>0){var acceptAlgStr=":"+acceptAlgs.join(":")+":";if(acceptAlgStr.indexOf(":"+alg+":")==-1){throw"algorithm '"+alg+"' not accepted in the list"}}if(alg!="none"&&key===null){throw"key shall be specified to verify."}if(typeof key=="string"&&key.indexOf("-----BEGIN ")!=-1){key=KEYUTIL.getKey(key)}if(algType=="RS"||algType=="PS"){if(!(key instanceof _RSAKey)){throw"key shall be a RSAKey obj for RS* and PS* algs"}}if(algType=="ES"){if(!(key instanceof _ECDSA)){throw"key shall be a ECDSA obj for ES* algs"}}if(alg=="none"){}var sigAlg=null;if(_KJUR_jws_JWS.jwsalg2sigalg[pHeader.alg]===undefined){throw"unsupported alg name: "+alg}else{sigAlg=_KJUR_jws_JWS.jwsalg2sigalg[alg]}if(sigAlg=="none"){throw"not supported"}else if(sigAlg.substr(0,4)=="Hmac"){var hSig2=null;if(key===undefined)throw"hexadecimal key shall be specified for HMAC";var mac=new _Mac({alg:sigAlg,pass:key});mac.updateString(uSignatureInput);hSig2=mac.doFinal();return hSig==hSig2}else if(sigAlg.indexOf("withECDSA")!=-1){var hASN1Sig=null;try{hASN1Sig=_ECDSA.concatSigToASN1Sig(hSig)}catch(ex){return false}var sig=new _Signature({alg:sigAlg});sig.init(key);sig.updateString(uSignatureInput);return sig.verify(hASN1Sig)}else{var sig=new _Signature({alg:sigAlg});sig.init(key);sig.updateString(uSignatureInput);return sig.verify(hSig)}};KJUR.jws.JWS.parse=function(sJWS){var a=sJWS.split(".");var result={};var uHeader,uPayload,uSig;if(a.length!=2&&a.length!=3)throw"malformed sJWS: wrong number of '.' splitted elements";uHeader=a[0];uPayload=a[1];if(a.length==3)uSig=a[2];result.headerObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(uHeader));result.payloadObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(uPayload));result.headerPP=JSON.stringify(result.headerObj,null,"  ");if(result.payloadObj==null){result.payloadPP=b64utoutf8(uPayload)}else{result.payloadPP=JSON.stringify(result.payloadObj,null,"  ")}if(uSig!==undefined){result.sigHex=b64utohex(uSig)}return result};KJUR.jws.JWS.verifyJWT=function(sJWT,key,acceptField){var _KJUR=KJUR,_KJUR_jws=_KJUR.jws,_KJUR_jws_JWS=_KJUR_jws.JWS,_readSafeJSONString=_KJUR_jws_JWS.readSafeJSONString,_inArray=_KJUR_jws_JWS.inArray,_includedArray=_KJUR_jws_JWS.includedArray;var a=sJWT.split(".");var uHeader=a[0];var uPayload=a[1];var uSignatureInput=uHeader+"."+uPayload;var hSig=b64utohex(a[2]);var pHeader=_readSafeJSONString(b64utoutf8(uHeader));var pPayload=_readSafeJSONString(b64utoutf8(uPayload));if(pHeader.alg===undefined)return false;if(acceptField.alg===undefined)throw"acceptField.alg shall be specified";if(!_inArray(pHeader.alg,acceptField.alg))return false;if(pPayload.iss!==undefined&&typeof acceptField.iss==="object"){if(!_inArray(pPayload.iss,acceptField.iss))return false}if(pPayload.sub!==undefined&&typeof acceptField.sub==="object"){if(!_inArray(pPayload.sub,acceptField.sub))return false}if(pPayload.aud!==undefined&&typeof acceptField.aud==="object"){if(typeof pPayload.aud=="string"){if(!_inArray(pPayload.aud,acceptField.aud))return false}else if(typeof pPayload.aud=="object"){if(!_includedArray(pPayload.aud,acceptField.aud))return false}}var now=_KJUR_jws.IntDate.getNow();if(acceptField.verifyAt!==undefined&&typeof acceptField.verifyAt==="number"){now=acceptField.verifyAt}if(acceptField.gracePeriod===undefined||typeof acceptField.gracePeriod!=="number"){acceptField.gracePeriod=0}if(pPayload.exp!==undefined&&typeof pPayload.exp=="number"){if(pPayload.exp+acceptField.gracePeriod<now)return false}if(pPayload.nbf!==undefined&&typeof pPayload.nbf=="number"){if(now<pPayload.nbf-acceptField.gracePeriod)return false}if(pPayload.iat!==undefined&&typeof pPayload.iat=="number"){if(now<pPayload.iat-acceptField.gracePeriod)return false}if(pPayload.jti!==undefined&&acceptField.jti!==undefined){if(pPayload.jti!==acceptField.jti)return false}if(!_KJUR_jws_JWS.verify(sJWT,key,acceptField.alg))return false;return true};KJUR.jws.JWS.includedArray=function(a1,a2){var _inArray=KJUR.jws.JWS.inArray;if(a1===null)return false;if(typeof a1!=="object")return false;if(typeof a1.length!=="number")return false;for(var i=0;i<a1.length;i++){if(!_inArray(a1[i],a2))return false}return true};KJUR.jws.JWS.inArray=function(item,a){if(a===null)return false;if(typeof a!=="object")return false;if(typeof a.length!=="number")return false;for(var i=0;i<a.length;i++){if(a[i]==item)return true}return false};KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"};KJUR.jws.JWS.isSafeJSONString=function(s,h,p){var o=null;try{o=jsonParse(s);if(typeof o!="object")return 0;if(o.constructor===Array)return 0;if(h)h[p]=o;return 1}catch(ex){return 0}};KJUR.jws.JWS.readSafeJSONString=function(s){var o=null;try{o=jsonParse(s);if(typeof o!="object")return null;if(o.constructor===Array)return null;return o}catch(ex){return null}};KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(sJWS){var matchResult=sJWS.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(matchResult==null){throw"JWS signature is not a form of 'Head.Payload.SigValue'."}return matchResult[1]};KJUR.jws.JWS.getJWKthumbprint=function(o){if(o.kty!=="RSA"&&o.kty!=="EC"&&o.kty!=="oct")throw"unsupported algorithm for JWK Thumprint";var s="{";if(o.kty==="RSA"){if(typeof o.n!="string"||typeof o.e!="string")throw"wrong n and e value for RSA key";s+='"'+"e"+'":"'+o.e+'",';s+='"'+"kty"+'":"'+o.kty+'",';s+='"'+"n"+'":"'+o.n+'"}'}else if(o.kty==="EC"){if(typeof o.crv!="string"||typeof o.x!="string"||typeof o.y!="string")throw"wrong crv, x and y value for EC key";s+='"'+"crv"+'":"'+o.crv+'",';s+='"'+"kty"+'":"'+o.kty+'",';s+='"'+"x"+'":"'+o.x+'",';s+='"'+"y"+'":"'+o.y+'"}'}else if(o.kty==="oct"){if(typeof o.k!="string")throw"wrong k value for oct(symmetric) key";s+='"'+"kty"+'":"'+o.kty+'",';s+='"'+"k"+'":"'+o.k+'"}'}var hJWK=rstrtohex(s);var hash=KJUR.crypto.Util.hashHex(hJWK,"sha256");var hashB64U=hextob64u(hash);return hashB64U};KJUR.jws.IntDate={};KJUR.jws.IntDate.get=function(s){var _KJUR_jws_IntDate=KJUR.jws.IntDate,_getNow=_KJUR_jws_IntDate.getNow,_getZulu=_KJUR_jws_IntDate.getZulu;if(s=="now"){return _getNow()}else if(s=="now + 1hour"){return _getNow()+60*60}else if(s=="now + 1day"){return _getNow()+60*60*24}else if(s=="now + 1month"){return _getNow()+60*60*24*30}else if(s=="now + 1year"){return _getNow()+60*60*24*365}else if(s.match(/Z$/)){return _getZulu(s)}else if(s.match(/^[0-9]+$/)){return parseInt(s)}throw"unsupported format: "+s};KJUR.jws.IntDate.getZulu=function(s){return zulutosec(s)};KJUR.jws.IntDate.getNow=function(){var d=~~(new Date/1e3);return d};KJUR.jws.IntDate.intDate2UTCString=function(intDate){var d=new Date(intDate*1e3);return d.toUTCString()};KJUR.jws.IntDate.intDate2Zulu=function(intDate){var d=new Date(intDate*1e3),year=("0000"+d.getUTCFullYear()).slice(-4),mon=("00"+(d.getUTCMonth()+1)).slice(-2),day=("00"+d.getUTCDate()).slice(-2),hour=("00"+d.getUTCHours()).slice(-2),min=("00"+d.getUTCMinutes()).slice(-2),sec=("00"+d.getUTCSeconds()).slice(-2);return year+mon+day+hour+min+sec+"Z"};