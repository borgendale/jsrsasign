var KEYUTIL=function(){var decryptAES=function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.AES,dataHex,keyHex,ivHex)};var decrypt3DES=function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.TripleDES,dataHex,keyHex,ivHex)};var decryptDES=function(dataHex,keyHex,ivHex){return decryptGeneral(CryptoJS.DES,dataHex,keyHex,ivHex)};var decryptGeneral=function(f,dataHex,keyHex,ivHex){var data=CryptoJS.enc.Hex.parse(dataHex);var key=CryptoJS.enc.Hex.parse(keyHex);var iv=CryptoJS.enc.Hex.parse(ivHex);var encrypted={};encrypted.key=key;encrypted.iv=iv;encrypted.ciphertext=data;var decrypted=f.decrypt(encrypted,key,{iv:iv});return CryptoJS.enc.Hex.stringify(decrypted)};var encryptAES=function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.AES,dataHex,keyHex,ivHex)};var encrypt3DES=function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.TripleDES,dataHex,keyHex,ivHex)};var encryptDES=function(dataHex,keyHex,ivHex){return encryptGeneral(CryptoJS.DES,dataHex,keyHex,ivHex)};var encryptGeneral=function(f,dataHex,keyHex,ivHex){var data=CryptoJS.enc.Hex.parse(dataHex);var key=CryptoJS.enc.Hex.parse(keyHex);var iv=CryptoJS.enc.Hex.parse(ivHex);var encryptedHex=f.encrypt(data,key,{iv:iv});var encryptedWA=CryptoJS.enc.Hex.parse(encryptedHex.toString());var encryptedB64=CryptoJS.enc.Base64.stringify(encryptedWA);return encryptedB64};var ALGLIST={"AES-256-CBC":{proc:decryptAES,eproc:encryptAES,keylen:32,ivlen:16},"AES-192-CBC":{proc:decryptAES,eproc:encryptAES,keylen:24,ivlen:16},"AES-128-CBC":{proc:decryptAES,eproc:encryptAES,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:decrypt3DES,eproc:encrypt3DES,keylen:24,ivlen:8},"DES-CBC":{proc:decryptDES,eproc:encryptDES,keylen:8,ivlen:8}};var getFuncByName=function(algName){return ALGLIST[algName]["proc"]};var _generateIvSaltHex=function(numBytes){var wa=CryptoJS.lib.WordArray.random(numBytes);var hex=CryptoJS.enc.Hex.stringify(wa);return hex};var _parsePKCS5PEM=function(sPKCS5PEM){var info={};var matchResult1=sPKCS5PEM.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));if(matchResult1){info.cipher=matchResult1[1];info.ivsalt=matchResult1[2]}var matchResult2=sPKCS5PEM.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));if(matchResult2){info.type=matchResult2[1]}var i1=-1;var lenNEWLINE=0;if(sPKCS5PEM.indexOf("\r\n\r\n")!=-1){i1=sPKCS5PEM.indexOf("\r\n\r\n");lenNEWLINE=2}if(sPKCS5PEM.indexOf("\n\n")!=-1){i1=sPKCS5PEM.indexOf("\n\n");lenNEWLINE=1}var i2=sPKCS5PEM.indexOf("-----END");if(i1!=-1&&i2!=-1){var s=sPKCS5PEM.substring(i1+lenNEWLINE*2,i2-lenNEWLINE);s=s.replace(/\s+/g,"");info.data=s}return info};var _getKeyAndUnusedIvByPasscodeAndIvsalt=function(algName,passcode,ivsaltHex){var saltHex=ivsaltHex.substring(0,16);var salt=CryptoJS.enc.Hex.parse(saltHex);var data=CryptoJS.enc.Utf8.parse(passcode);var nRequiredBytes=ALGLIST[algName]["keylen"]+ALGLIST[algName]["ivlen"];var hHexValueJoined="";var hLastValue=null;for(;;){var h=CryptoJS.algo.MD5.create();if(hLastValue!=null){h.update(hLastValue)}h.update(data);h.update(salt);hLastValue=h.finalize();hHexValueJoined=hHexValueJoined+CryptoJS.enc.Hex.stringify(hLastValue);if(hHexValueJoined.length>=nRequiredBytes*2){break}}var result={};result.keyhex=hHexValueJoined.substr(0,ALGLIST[algName]["keylen"]*2);result.ivhex=hHexValueJoined.substr(ALGLIST[algName]["keylen"]*2,ALGLIST[algName]["ivlen"]*2);return result};var _decryptKeyB64=function(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex){var privateKeyWA=CryptoJS.enc.Base64.parse(privateKeyB64);var privateKeyHex=CryptoJS.enc.Hex.stringify(privateKeyWA);var f=ALGLIST[sharedKeyAlgName]["proc"];var decryptedKeyHex=f(privateKeyHex,sharedKeyHex,ivsaltHex);return decryptedKeyHex};var _encryptKeyHex=function(privateKeyHex,sharedKeyAlgName,sharedKeyHex,ivsaltHex){var f=ALGLIST[sharedKeyAlgName]["eproc"];var encryptedKeyB64=f(privateKeyHex,sharedKeyHex,ivsaltHex);return encryptedKeyB64};return{version:"1.0.0",parsePKCS5PEM:function(sPKCS5PEM){return _parsePKCS5PEM(sPKCS5PEM)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(algName,passcode,ivsaltHex){return _getKeyAndUnusedIvByPasscodeAndIvsalt(algName,passcode,ivsaltHex)},decryptKeyB64:function(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex){return _decryptKeyB64(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex)},getDecryptedKeyHex:function(sEncryptedPEM,passcode){var info=_parsePKCS5PEM(sEncryptedPEM);var publicKeyAlgName=info.type;var sharedKeyAlgName=info.cipher;var ivsaltHex=info.ivsalt;var privateKeyB64=info.data;var sharedKeyInfo=_getKeyAndUnusedIvByPasscodeAndIvsalt(sharedKeyAlgName,passcode,ivsaltHex);var sharedKeyHex=sharedKeyInfo.keyhex;var decryptedKey=_decryptKeyB64(privateKeyB64,sharedKeyAlgName,sharedKeyHex,ivsaltHex);return decryptedKey},getEncryptedPKCS5PEMFromPrvKeyHex:function(pemHeadAlg,hPrvKey,passcode,sharedKeyAlgName,ivsaltHex){var sPEM="";if(typeof sharedKeyAlgName=="undefined"||sharedKeyAlgName==null){sharedKeyAlgName="AES-256-CBC"}if(typeof ALGLIST[sharedKeyAlgName]=="undefined")throw"KEYUTIL unsupported algorithm: "+sharedKeyAlgName;if(typeof ivsaltHex=="undefined"||ivsaltHex==null){var ivlen=ALGLIST[sharedKeyAlgName]["ivlen"];var randIV=_generateIvSaltHex(ivlen);ivsaltHex=randIV.toUpperCase()}var sharedKeyInfo=_getKeyAndUnusedIvByPasscodeAndIvsalt(sharedKeyAlgName,passcode,ivsaltHex);var sharedKeyHex=sharedKeyInfo.keyhex;var encryptedKeyB64=_encryptKeyHex(hPrvKey,sharedKeyAlgName,sharedKeyHex,ivsaltHex);var pemBody=encryptedKeyB64.replace(/(.{64})/g,"$1\r\n");var sPEM="-----BEGIN "+pemHeadAlg+" PRIVATE KEY-----\r\n";sPEM+="Proc-Type: 4,ENCRYPTED\r\n";sPEM+="DEK-Info: "+sharedKeyAlgName+","+ivsaltHex+"\r\n";sPEM+="\r\n";sPEM+=pemBody;sPEM+="\r\n-----END "+pemHeadAlg+" PRIVATE KEY-----\r\n";return sPEM},parseHexOfEncryptedPKCS8:function(sHEX){var _ASN1HEX=ASN1HEX;var _getChildIdx=_ASN1HEX.getChildIdx;var _getV=_ASN1HEX.getV;var info={};var a0=_getChildIdx(sHEX,0);if(a0.length!=2)throw"malformed format: SEQUENCE(0).items != 2: "+a0.length;info.ciphertext=_getV(sHEX,a0[1]);var a0_0=_getChildIdx(sHEX,a0[0]);if(a0_0.length!=2)throw"malformed format: SEQUENCE(0.0).items != 2: "+a0_0.length;if(_getV(sHEX,a0_0[0])!="2a864886f70d01050d")throw"this only supports pkcs5PBES2";var a0_0_1=_getChildIdx(sHEX,a0_0[1]);if(a0_0.length!=2)throw"malformed format: SEQUENCE(0.0.1).items != 2: "+a0_0_1.length;var a0_0_1_1=_getChildIdx(sHEX,a0_0_1[1]);if(a0_0_1_1.length!=2)throw"malformed format: SEQUENCE(0.0.1.1).items != 2: "+a0_0_1_1.length;if(_getV(sHEX,a0_0_1_1[0])!="2a864886f70d0307")throw"this only supports TripleDES";info.encryptionSchemeAlg="TripleDES";info.encryptionSchemeIV=_getV(sHEX,a0_0_1_1[1]);var a0_0_1_0=_getChildIdx(sHEX,a0_0_1[0]);if(a0_0_1_0.length!=2)throw"malformed format: SEQUENCE(0.0.1.0).items != 2: "+a0_0_1_0.length;if(_getV(sHEX,a0_0_1_0[0])!="2a864886f70d01050c")throw"this only supports pkcs5PBKDF2";var a0_0_1_0_1=_getChildIdx(sHEX,a0_0_1_0[1]);if(a0_0_1_0_1.length<2)throw"malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+a0_0_1_0_1.length;info.pbkdf2Salt=_getV(sHEX,a0_0_1_0_1[0]);var iterNumHex=_getV(sHEX,a0_0_1_0_1[1]);try{info.pbkdf2Iter=parseInt(iterNumHex,16)}catch(ex){throw"malformed format pbkdf2Iter: "+iterNumHex}return info},getPBKDF2KeyHexFromParam:function(info,passcode){var pbkdf2SaltWS=CryptoJS.enc.Hex.parse(info.pbkdf2Salt);var pbkdf2Iter=info.pbkdf2Iter;var pbkdf2KeyWS=CryptoJS.PBKDF2(passcode,pbkdf2SaltWS,{keySize:192/32,iterations:pbkdf2Iter});var pbkdf2KeyHex=CryptoJS.enc.Hex.stringify(pbkdf2KeyWS);return pbkdf2KeyHex},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(pkcs8PEM,passcode){var derHex=pemtohex(pkcs8PEM,"ENCRYPTED PRIVATE KEY");var info=this.parseHexOfEncryptedPKCS8(derHex);var pbkdf2KeyHex=KEYUTIL.getPBKDF2KeyHexFromParam(info,passcode);var encrypted={};encrypted.ciphertext=CryptoJS.enc.Hex.parse(info.ciphertext);var pbkdf2KeyWS=CryptoJS.enc.Hex.parse(pbkdf2KeyHex);var des3IVWS=CryptoJS.enc.Hex.parse(info.encryptionSchemeIV);var decWS=CryptoJS.TripleDES.decrypt(encrypted,pbkdf2KeyWS,{iv:des3IVWS});var decHex=CryptoJS.enc.Hex.stringify(decWS);return decHex},getKeyFromEncryptedPKCS8PEM:function(pkcs8PEM,passcode){var prvKeyHex=this._getPlainPKCS8HexFromEncryptedPKCS8PEM(pkcs8PEM,passcode);var key=this.getKeyFromPlainPrivatePKCS8Hex(prvKeyHex);return key},parsePlainPrivatePKCS8Hex:function(pkcs8PrvHex){var _ASN1HEX=ASN1HEX;var _getChildIdx=_ASN1HEX.getChildIdx;var _getV=_ASN1HEX.getV;var result={};result.algparam=null;if(pkcs8PrvHex.substr(0,2)!="30")throw"malformed plain PKCS8 private key(code:001)";var a1=_getChildIdx(pkcs8PrvHex,0);if(a1.length!=3)throw"malformed plain PKCS8 private key(code:002)";if(pkcs8PrvHex.substr(a1[1],2)!="30")throw"malformed PKCS8 private key(code:003)";var a2=_getChildIdx(pkcs8PrvHex,a1[1]);if(a2.length!=2)throw"malformed PKCS8 private key(code:004)";if(pkcs8PrvHex.substr(a2[0],2)!="06")throw"malformed PKCS8 private key(code:005)";result.algoid=_getV(pkcs8PrvHex,a2[0]);if(pkcs8PrvHex.substr(a2[1],2)=="06"){result.algparam=_getV(pkcs8PrvHex,a2[1])}if(pkcs8PrvHex.substr(a1[2],2)!="04")throw"malformed PKCS8 private key(code:006)";result.keyidx=_ASN1HEX.getVidx(pkcs8PrvHex,a1[2]);return result},getKeyFromPlainPrivatePKCS8PEM:function(prvKeyPEM){var prvKeyHex=pemtohex(prvKeyPEM,"PRIVATE KEY");var key=this.getKeyFromPlainPrivatePKCS8Hex(prvKeyHex);return key},getKeyFromPlainPrivatePKCS8Hex:function(prvKeyHex){var p8=this.parsePlainPrivatePKCS8Hex(prvKeyHex);var key;if(p8.algoid=="2a864886f70d010101"){key=new RSAKey}else if(p8.algoid=="2a8648ce380401"){key=new KJUR.crypto.DSA}else if(p8.algoid=="2a8648ce3d0201"){key=new KJUR.crypto.ECDSA}else{throw"unsupported private key algorithm"}key.readPKCS8PrvKeyHex(prvKeyHex);return key},_getKeyFromPublicPKCS8Hex:function(h){var key;var hOID=ASN1HEX.getVbyList(h,0,[0,0],"06");if(hOID==="2a864886f70d010101"){key=new RSAKey}else if(hOID==="2a8648ce380401"){key=new KJUR.crypto.DSA}else if(hOID==="2a8648ce3d0201"){key=new KJUR.crypto.ECDSA}else{throw"unsupported PKCS#8 public key hex"}key.readPKCS8PubKeyHex(h);return key},parsePublicRawRSAKeyHex:function(pubRawRSAHex){var _ASN1HEX=ASN1HEX;var _getChildIdx=_ASN1HEX.getChildIdx;var _getV=_ASN1HEX.getV;var result={};if(pubRawRSAHex.substr(0,2)!="30")throw"malformed RSA key(code:001)";var a1=_getChildIdx(pubRawRSAHex,0);if(a1.length!=2)throw"malformed RSA key(code:002)";if(pubRawRSAHex.substr(a1[0],2)!="02")throw"malformed RSA key(code:003)";result.n=_getV(pubRawRSAHex,a1[0]);if(pubRawRSAHex.substr(a1[1],2)!="02")throw"malformed RSA key(code:004)";result.e=_getV(pubRawRSAHex,a1[1]);return result},parsePublicPKCS8Hex:function(pkcs8PubHex){var _ASN1HEX=ASN1HEX;var _getChildIdx=_ASN1HEX.getChildIdx;var _getV=_ASN1HEX.getV;var result={};result.algparam=null;var a1=_getChildIdx(pkcs8PubHex,0);if(a1.length!=2)throw"outer DERSequence shall have 2 elements: "+a1.length;var idxAlgIdTLV=a1[0];if(pkcs8PubHex.substr(idxAlgIdTLV,2)!="30")throw"malformed PKCS8 public key(code:001)";var a2=_getChildIdx(pkcs8PubHex,idxAlgIdTLV);if(a2.length!=2)throw"malformed PKCS8 public key(code:002)";if(pkcs8PubHex.substr(a2[0],2)!="06")throw"malformed PKCS8 public key(code:003)";result.algoid=_getV(pkcs8PubHex,a2[0]);if(pkcs8PubHex.substr(a2[1],2)=="06"){result.algparam=_getV(pkcs8PubHex,a2[1])}else if(pkcs8PubHex.substr(a2[1],2)=="30"){result.algparam={};result.algparam.p=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[0],"02");result.algparam.q=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[1],"02");result.algparam.g=_ASN1HEX.getVbyList(pkcs8PubHex,a2[1],[2],"02")}if(pkcs8PubHex.substr(a1[1],2)!="03")throw"malformed PKCS8 public key(code:004)";result.key=_getV(pkcs8PubHex,a1[1]).substr(2);return result}}}();KEYUTIL.getKey=function(param,passcode,hextype){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,_getVbyList=_ASN1HEX.getVbyList,_KJUR_crypto=KJUR.crypto,_KJUR_crypto_ECDSA=_KJUR_crypto.ECDSA,_KJUR_crypto_DSA=_KJUR_crypto.DSA,_RSAKey=RSAKey,_pemtohex=pemtohex,_KEYUTIL=KEYUTIL;if(typeof _RSAKey!="undefined"&&param instanceof _RSAKey)return param;if(typeof _KJUR_crypto_ECDSA!="undefined"&&param instanceof _KJUR_crypto_ECDSA)return param;if(typeof _KJUR_crypto_DSA!="undefined"&&param instanceof _KJUR_crypto_DSA)return param;if(param.curve!==undefined&&param.xy!==undefined&&param.d===undefined){return new _KJUR_crypto_ECDSA({pub:param.xy,curve:param.curve})}if(param.curve!==undefined&&param.d!==undefined){return new _KJUR_crypto_ECDSA({prv:param.d,curve:param.curve})}if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d===undefined){var key=new _RSAKey;key.setPublic(param.n,param.e);return key}if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p!==undefined&&param.q!==undefined&&param.dp!==undefined&&param.dq!==undefined&&param.co!==undefined&&param.qi===undefined){var key=new _RSAKey;key.setPrivateEx(param.n,param.e,param.d,param.p,param.q,param.dp,param.dq,param.co);return key}if(param.kty===undefined&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p===undefined){var key=new _RSAKey;key.setPrivate(param.n,param.e,param.d);return key}if(param.p!==undefined&&param.q!==undefined&&param.g!==undefined&&param.y!==undefined&&param.x===undefined){var key=new _KJUR_crypto_DSA;key.setPublic(param.p,param.q,param.g,param.y);return key}if(param.p!==undefined&&param.q!==undefined&&param.g!==undefined&&param.y!==undefined&&param.x!==undefined){var key=new _KJUR_crypto_DSA;key.setPrivate(param.p,param.q,param.g,param.y,param.x);return key}if(param.kty==="RSA"&&param.n!==undefined&&param.e!==undefined&&param.d===undefined){var key=new _RSAKey;key.setPublic(b64utohex(param.n),b64utohex(param.e));return key}if(param.kty==="RSA"&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined&&param.p!==undefined&&param.q!==undefined&&param.dp!==undefined&&param.dq!==undefined&&param.qi!==undefined){var key=new _RSAKey;key.setPrivateEx(b64utohex(param.n),b64utohex(param.e),b64utohex(param.d),b64utohex(param.p),b64utohex(param.q),b64utohex(param.dp),b64utohex(param.dq),b64utohex(param.qi));return key}if(param.kty==="RSA"&&param.n!==undefined&&param.e!==undefined&&param.d!==undefined){var key=new _RSAKey;key.setPrivate(b64utohex(param.n),b64utohex(param.e),b64utohex(param.d));return key}if(param.kty==="EC"&&param.crv!==undefined&&param.x!==undefined&&param.y!==undefined&&param.d===undefined){var ec=new _KJUR_crypto_ECDSA({curve:param.crv});var charlen=ec.ecparams.keylen/4;var hX=("0000000000"+b64utohex(param.x)).slice(-charlen);var hY=("0000000000"+b64utohex(param.y)).slice(-charlen);var hPub="04"+hX+hY;ec.setPublicKeyHex(hPub);return ec}if(param.kty==="EC"&&param.crv!==undefined&&param.x!==undefined&&param.y!==undefined&&param.d!==undefined){var ec=new _KJUR_crypto_ECDSA({curve:param.crv});var charlen=ec.ecparams.keylen/4;var hX=("0000000000"+b64utohex(param.x)).slice(-charlen);var hY=("0000000000"+b64utohex(param.y)).slice(-charlen);var hPub="04"+hX+hY;var hPrv=("0000000000"+b64utohex(param.d)).slice(-charlen);ec.setPublicKeyHex(hPub);ec.setPrivateKeyHex(hPrv);return ec}if(hextype==="pkcs5prv"){var h=param,_ASN1HEX=ASN1HEX,a,key;a=_getChildIdx(h,0);if(a.length===9){key=new _RSAKey;key.readPKCS5PrvKeyHex(h)}else if(a.length===6){key=new _KJUR_crypto_DSA;key.readPKCS5PrvKeyHex(h)}else if(a.length>2&&h.substr(a[1],2)==="04"){key=new _KJUR_crypto_ECDSA;key.readPKCS5PrvKeyHex(h)}else{throw"unsupported PKCS#1/5 hexadecimal key"}return key}if(hextype==="pkcs8prv"){var key=_KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(param);return key}if(hextype==="pkcs8pub"){return _KEYUTIL._getKeyFromPublicPKCS8Hex(param)}if(hextype==="x509pub"){return X509.getPublicKeyFromCertHex(param)}if(param.indexOf("-END CERTIFICATE-",0)!=-1||param.indexOf("-END X509 CERTIFICATE-",0)!=-1||param.indexOf("-END TRUSTED CERTIFICATE-",0)!=-1){return X509.getPublicKeyFromCertPEM(param)}if(param.indexOf("-END PUBLIC KEY-")!=-1){var pubKeyHex=pemtohex(param,"PUBLIC KEY");return _KEYUTIL._getKeyFromPublicPKCS8Hex(pubKeyHex)}if(param.indexOf("-END RSA PRIVATE KEY-")!=-1&&param.indexOf("4,ENCRYPTED")==-1){var hex=_pemtohex(param,"RSA PRIVATE KEY");return _KEYUTIL.getKey(hex,null,"pkcs5prv")}if(param.indexOf("-END DSA PRIVATE KEY-")!=-1&&param.indexOf("4,ENCRYPTED")==-1){var hKey=_pemtohex(param,"DSA PRIVATE KEY");var p=_getVbyList(hKey,0,[1],"02");var q=_getVbyList(hKey,0,[2],"02");var g=_getVbyList(hKey,0,[3],"02");var y=_getVbyList(hKey,0,[4],"02");var x=_getVbyList(hKey,0,[5],"02");var key=new _KJUR_crypto_DSA;key.setPrivate(new BigInteger(p,16),new BigInteger(q,16),new BigInteger(g,16),new BigInteger(y,16),new BigInteger(x,16));return key}if(param.indexOf("-END PRIVATE KEY-")!=-1){return _KEYUTIL.getKeyFromPlainPrivatePKCS8PEM(param)}if(param.indexOf("-END RSA PRIVATE KEY-")!=-1&&param.indexOf("4,ENCRYPTED")!=-1){var hPKey=_KEYUTIL.getDecryptedKeyHex(param,passcode);var rsaKey=new RSAKey;rsaKey.readPKCS5PrvKeyHex(hPKey);return rsaKey}if(param.indexOf("-END EC PRIVATE KEY-")!=-1&&param.indexOf("4,ENCRYPTED")!=-1){var hKey=_KEYUTIL.getDecryptedKeyHex(param,passcode);var key=_getVbyList(hKey,0,[1],"04");var curveNameOidHex=_getVbyList(hKey,0,[2,0],"06");var pubkey=_getVbyList(hKey,0,[3,0],"03").substr(2);var curveName="";if(KJUR.crypto.OID.oidhex2name[curveNameOidHex]!==undefined){curveName=KJUR.crypto.OID.oidhex2name[curveNameOidHex]}else{throw"undefined OID(hex) in KJUR.crypto.OID: "+curveNameOidHex}var ec=new _KJUR_crypto_ECDSA({curve:curveName});ec.setPublicKeyHex(pubkey);ec.setPrivateKeyHex(key);ec.isPublic=false;return ec}if(param.indexOf("-END DSA PRIVATE KEY-")!=-1&&param.indexOf("4,ENCRYPTED")!=-1){var hKey=_KEYUTIL.getDecryptedKeyHex(param,passcode);var p=_getVbyList(hKey,0,[1],"02");var q=_getVbyList(hKey,0,[2],"02");var g=_getVbyList(hKey,0,[3],"02");var y=_getVbyList(hKey,0,[4],"02");var x=_getVbyList(hKey,0,[5],"02");var key=new _KJUR_crypto_DSA;key.setPrivate(new BigInteger(p,16),new BigInteger(q,16),new BigInteger(g,16),new BigInteger(y,16),new BigInteger(x,16));return key}if(param.indexOf("-END ENCRYPTED PRIVATE KEY-")!=-1){return _KEYUTIL.getKeyFromEncryptedPKCS8PEM(param,passcode)}throw"not supported argument"};KEYUTIL.generateKeypair=function(alg,keylenOrCurve){if(alg=="RSA"){var keylen=keylenOrCurve;var prvKey=new RSAKey;prvKey.generate(keylen,"10001");prvKey.isPrivate=true;prvKey.isPublic=true;var pubKey=new RSAKey;var hN=prvKey.n.toString(16);var hE=prvKey.e.toString(16);pubKey.setPublic(hN,hE);pubKey.isPrivate=false;pubKey.isPublic=true;var result={};result.prvKeyObj=prvKey;result.pubKeyObj=pubKey;return result}else if(alg=="EC"){var curve=keylenOrCurve;var ec=new KJUR.crypto.ECDSA({curve:curve});var keypairHex=ec.generateKeyPairHex();var prvKey=new KJUR.crypto.ECDSA({curve:curve});prvKey.setPublicKeyHex(keypairHex.ecpubhex);prvKey.setPrivateKeyHex(keypairHex.ecprvhex);prvKey.isPrivate=true;prvKey.isPublic=false;var pubKey=new KJUR.crypto.ECDSA({curve:curve});pubKey.setPublicKeyHex(keypairHex.ecpubhex);pubKey.isPrivate=false;pubKey.isPublic=true;var result={};result.prvKeyObj=prvKey;result.pubKeyObj=pubKey;return result}else{throw"unknown algorithm: "+alg}};KEYUTIL.getPEM=function(keyObjOrHex,formatType,passwd,encAlg,hexType,ivsaltHex){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DERInteger=_KJUR_asn1.DERInteger,_newObject=_KJUR_asn1.ASN1Util.newObject,_KJUR_asn1_x509=_KJUR_asn1.x509,_SubjectPublicKeyInfo=_KJUR_asn1_x509.SubjectPublicKeyInfo,_KJUR_crypto=_KJUR.crypto,_DSA=_KJUR_crypto.DSA,_ECDSA=_KJUR_crypto.ECDSA,_RSAKey=RSAKey;function _rsaprv2asn1obj(keyObjOrHex){var asn1Obj=_newObject({seq:[{int:0},{int:{bigint:keyObjOrHex.n}},{int:keyObjOrHex.e},{int:{bigint:keyObjOrHex.d}},{int:{bigint:keyObjOrHex.p}},{int:{bigint:keyObjOrHex.q}},{int:{bigint:keyObjOrHex.dmp1}},{int:{bigint:keyObjOrHex.dmq1}},{int:{bigint:keyObjOrHex.coeff}}]});return asn1Obj}function _ecdsaprv2asn1obj(keyObjOrHex){var asn1Obj2=_newObject({seq:[{int:1},{octstr:{hex:keyObjOrHex.prvKeyHex}},{tag:["a0",true,{oid:{name:keyObjOrHex.curveName}}]},{tag:["a1",true,{bitstr:{hex:"00"+keyObjOrHex.pubKeyHex}}]}]});return asn1Obj2}function _dsaprv2asn1obj(keyObjOrHex){var asn1Obj=_newObject({seq:[{int:0},{int:{bigint:keyObjOrHex.p}},{int:{bigint:keyObjOrHex.q}},{int:{bigint:keyObjOrHex.g}},{int:{bigint:keyObjOrHex.y}},{int:{bigint:keyObjOrHex.x}}]});return asn1Obj}if((_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey||_DSA!==undefined&&keyObjOrHex instanceof _DSA||_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA)&&keyObjOrHex.isPublic==true&&(formatType===undefined||formatType=="PKCS8PUB")){var asn1Obj=new _SubjectPublicKeyInfo(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();return hextopem(asn1Hex,"PUBLIC KEY")}if(formatType=="PKCS1PRV"&&_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey&&(passwd===undefined||passwd==null)&&keyObjOrHex.isPrivate==true){var asn1Obj=_rsaprv2asn1obj(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();return hextopem(asn1Hex,"RSA PRIVATE KEY")}if(formatType=="PKCS1PRV"&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&(passwd===undefined||passwd==null)&&keyObjOrHex.isPrivate==true){var asn1Obj1=new _DERObjectIdentifier({name:keyObjOrHex.curveName});var asn1Hex1=asn1Obj1.getEncodedHex();var asn1Obj2=_ecdsaprv2asn1obj(keyObjOrHex);var asn1Hex2=asn1Obj2.getEncodedHex();var s="";s+=hextopem(asn1Hex1,"EC PARAMETERS");s+=hextopem(asn1Hex2,"EC PRIVATE KEY");return s}if(formatType=="PKCS1PRV"&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&(passwd===undefined||passwd==null)&&keyObjOrHex.isPrivate==true){var asn1Obj=_dsaprv2asn1obj(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();return hextopem(asn1Hex,"DSA PRIVATE KEY")}if(formatType=="PKCS5PRV"&&_RSAKey!==undefined&&keyObjOrHex instanceof _RSAKey&&(passwd!==undefined&&passwd!=null)&&keyObjOrHex.isPrivate==true){var asn1Obj=_rsaprv2asn1obj(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();if(encAlg===undefined)encAlg="DES-EDE3-CBC";return this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",asn1Hex,passwd,encAlg,ivsaltHex)}if(formatType=="PKCS5PRV"&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&(passwd!==undefined&&passwd!=null)&&keyObjOrHex.isPrivate==true){var asn1Obj=_ecdsaprv2asn1obj(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();if(encAlg===undefined)encAlg="DES-EDE3-CBC";return this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",asn1Hex,passwd,encAlg,ivsaltHex)}if(formatType=="PKCS5PRV"&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&(passwd!==undefined&&passwd!=null)&&keyObjOrHex.isPrivate==true){var asn1Obj=_dsaprv2asn1obj(keyObjOrHex);var asn1Hex=asn1Obj.getEncodedHex();if(encAlg===undefined)encAlg="DES-EDE3-CBC";return this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",asn1Hex,passwd,encAlg,ivsaltHex)}var _getEncryptedPKCS8=function(plainKeyHex,passcode){var info=_getEencryptedPKCS8Info(plainKeyHex,passcode);var asn1Obj=new _newObject({seq:[{seq:[{oid:{name:"pkcs5PBES2"}},{seq:[{seq:[{oid:{name:"pkcs5PBKDF2"}},{seq:[{octstr:{hex:info.pbkdf2Salt}},{int:info.pbkdf2Iter}]}]},{seq:[{oid:{name:"des-EDE3-CBC"}},{octstr:{hex:info.encryptionSchemeIV}}]}]}]},{octstr:{hex:info.ciphertext}}]});return asn1Obj.getEncodedHex()};var _getEencryptedPKCS8Info=function(plainKeyHex,passcode){var pbkdf2Iter=100;var pbkdf2SaltWS=CryptoJS.lib.WordArray.random(8);var encryptionSchemeAlg="DES-EDE3-CBC";var encryptionSchemeIVWS=CryptoJS.lib.WordArray.random(8);var pbkdf2KeyWS=CryptoJS.PBKDF2(passcode,pbkdf2SaltWS,{keySize:192/32,iterations:pbkdf2Iter});var plainKeyWS=CryptoJS.enc.Hex.parse(plainKeyHex);var encryptedKeyHex=CryptoJS.TripleDES.encrypt(plainKeyWS,pbkdf2KeyWS,{iv:encryptionSchemeIVWS})+"";var info={};info.ciphertext=encryptedKeyHex;info.pbkdf2Salt=CryptoJS.enc.Hex.stringify(pbkdf2SaltWS);info.pbkdf2Iter=pbkdf2Iter;info.encryptionSchemeAlg=encryptionSchemeAlg;info.encryptionSchemeIV=CryptoJS.enc.Hex.stringify(encryptionSchemeIVWS);return info};if(formatType=="PKCS8PRV"&&_RSAKey!=undefined&&keyObjOrHex instanceof _RSAKey&&keyObjOrHex.isPrivate==true){var keyObj=_rsaprv2asn1obj(keyObjOrHex);var keyHex=keyObj.getEncodedHex();var asn1Obj=_newObject({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:true}]},{octstr:{hex:keyHex}}]});var asn1Hex=asn1Obj.getEncodedHex();if(passwd===undefined||passwd==null){return hextopem(asn1Hex,"PRIVATE KEY")}else{var asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd);return hextopem(asn1Hex2,"ENCRYPTED PRIVATE KEY")}}if(formatType=="PKCS8PRV"&&_ECDSA!==undefined&&keyObjOrHex instanceof _ECDSA&&keyObjOrHex.isPrivate==true){var keyObj=new _newObject({seq:[{int:1},{octstr:{hex:keyObjOrHex.prvKeyHex}},{tag:["a1",true,{bitstr:{hex:"00"+keyObjOrHex.pubKeyHex}}]}]});var keyHex=keyObj.getEncodedHex();var asn1Obj=_newObject({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:keyObjOrHex.curveName}}]},{octstr:{hex:keyHex}}]});var asn1Hex=asn1Obj.getEncodedHex();if(passwd===undefined||passwd==null){return hextopem(asn1Hex,"PRIVATE KEY")}else{var asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd);return hextopem(asn1Hex2,"ENCRYPTED PRIVATE KEY")}}if(formatType=="PKCS8PRV"&&_DSA!==undefined&&keyObjOrHex instanceof _DSA&&keyObjOrHex.isPrivate==true){var keyObj=new _DERInteger({bigint:keyObjOrHex.x});var keyHex=keyObj.getEncodedHex();var asn1Obj=_newObject({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:keyObjOrHex.p}},{int:{bigint:keyObjOrHex.q}},{int:{bigint:keyObjOrHex.g}}]}]},{octstr:{hex:keyHex}}]});var asn1Hex=asn1Obj.getEncodedHex();if(passwd===undefined||passwd==null){return hextopem(asn1Hex,"PRIVATE KEY")}else{var asn1Hex2=_getEncryptedPKCS8(asn1Hex,passwd);return hextopem(asn1Hex2,"ENCRYPTED PRIVATE KEY")}}throw"unsupported object nor format"};KEYUTIL.getKeyFromCSRPEM=function(csrPEM){var csrHex=pemtohex(csrPEM,"CERTIFICATE REQUEST");var key=KEYUTIL.getKeyFromCSRHex(csrHex);return key};KEYUTIL.getKeyFromCSRHex=function(csrHex){var info=KEYUTIL.parseCSRHex(csrHex);var key=KEYUTIL.getKey(info.p8pubkeyhex,null,"pkcs8pub");return key};KEYUTIL.parseCSRHex=function(csrHex){var _ASN1HEX=ASN1HEX;var _getChildIdx=_ASN1HEX.getChildIdx;var _getTLV=_ASN1HEX.getTLV;var result={};var h=csrHex;if(h.substr(0,2)!="30")throw"malformed CSR(code:001)";var a1=_getChildIdx(h,0);if(a1.length<1)throw"malformed CSR(code:002)";if(h.substr(a1[0],2)!="30")throw"malformed CSR(code:003)";var a2=_getChildIdx(h,a1[0]);if(a2.length<3)throw"malformed CSR(code:004)";result.p8pubkeyhex=_getTLV(h,a2[2]);return result};KEYUTIL.getJWKFromKey=function(keyObj){var jwk={};if(keyObj instanceof RSAKey&&keyObj.isPrivate){jwk.kty="RSA";jwk.n=hextob64u(keyObj.n.toString(16));jwk.e=hextob64u(keyObj.e.toString(16));jwk.d=hextob64u(keyObj.d.toString(16));jwk.p=hextob64u(keyObj.p.toString(16));jwk.q=hextob64u(keyObj.q.toString(16));jwk.dp=hextob64u(keyObj.dmp1.toString(16));jwk.dq=hextob64u(keyObj.dmq1.toString(16));jwk.qi=hextob64u(keyObj.coeff.toString(16));return jwk}else if(keyObj instanceof RSAKey&&keyObj.isPublic){jwk.kty="RSA";jwk.n=hextob64u(keyObj.n.toString(16));jwk.e=hextob64u(keyObj.e.toString(16));return jwk}else if(keyObj instanceof KJUR.crypto.ECDSA&&keyObj.isPrivate){var name=keyObj.getShortNISTPCurveName();if(name!=="P-256"&&name!=="P-384")throw"unsupported curve name for JWT: "+name;var xy=keyObj.getPublicKeyXYHex();jwk.kty="EC";jwk.crv=name;jwk.x=hextob64u(xy.x);jwk.y=hextob64u(xy.y);jwk.d=hextob64u(keyObj.prvKeyHex);return jwk}else if(keyObj instanceof KJUR.crypto.ECDSA&&keyObj.isPublic){var name=keyObj.getShortNISTPCurveName();if(name!=="P-256"&&name!=="P-384")throw"unsupported curve name for JWT: "+name;var xy=keyObj.getPublicKeyXYHex();jwk.kty="EC";jwk.crv=name;jwk.x=hextob64u(xy.x);jwk.y=hextob64u(xy.y);return jwk}throw"not supported key object"};