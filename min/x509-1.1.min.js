function X509(){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getV=_ASN1HEX.getV,_getTLV=_ASN1HEX.getTLV,_getVbyList=_ASN1HEX.getVbyList,_getTLVbyList=_ASN1HEX.getTLVbyList,_getIdxbyList=_ASN1HEX.getIdxbyList,_getVidx=_ASN1HEX.getVidx,_oidname=_ASN1HEX.oidname,_X509=X509,_pemtohex=pemtohex;this.hex=null;this.version=0;this.foffset=0;this.aExtInfo=null;this.getVersion=function(){if(this.hex===null||this.version!==0)return this.version;if(_getTLVbyList(this.hex,0,[0,0])!=="a003020102"){this.version=1;this.foffset=-1;return 1}this.version=3;return 3};this.getSerialNumberHex=function(){return _getVbyList(this.hex,0,[0,1+this.foffset],"02")};this.getSignatureAlgorithmField=function(){return _oidname(_getVbyList(this.hex,0,[0,2+this.foffset,0],"06"))};this.getIssuerHex=function(){return _getTLVbyList(this.hex,0,[0,3+this.foffset],"30")};this.getIssuerString=function(){return _X509.hex2dn(this.getIssuerHex())};this.getSubjectHex=function(){return _getTLVbyList(this.hex,0,[0,5+this.foffset],"30")};this.getSubjectString=function(){return _X509.hex2dn(this.getSubjectHex())};this.getNotBefore=function(){var s=_getVbyList(this.hex,0,[0,4+this.foffset,0]);s=s.replace(/(..)/g,"%$1");s=decodeURIComponent(s);return s};this.getNotAfter=function(){var s=_getVbyList(this.hex,0,[0,4+this.foffset,1]);s=s.replace(/(..)/g,"%$1");s=decodeURIComponent(s);return s};this.getPublicKeyHex=function(){return _ASN1HEX.getTLVbyList(this.hex,0,[0,6+this.foffset],"30")};this.getPublicKeyIdx=function(){return _getIdxbyList(this.hex,0,[0,6+this.foffset],"30")};this.getPublicKeyContentIdx=function(){var idx=this.getPublicKeyIdx();return _getIdxbyList(this.hex,idx,[1,0],"30")};this.getPublicKey=function(){return KEYUTIL.getKey(this.getPublicKeyHex(),null,"pkcs8pub")};this.getSignatureAlgorithmName=function(){return _oidname(_getVbyList(this.hex,0,[1,0],"06"))};this.getSignatureValueHex=function(){return _getVbyList(this.hex,0,[2],"03",true)};this.verifySignature=function(pubKey){var algName=this.getSignatureAlgorithmName();var hSigVal=this.getSignatureValueHex();var hTbsCert=_getTLVbyList(this.hex,0,[0],"30");var sig=new KJUR.crypto.Signature({alg:algName});sig.init(pubKey);sig.updateHex(hTbsCert);return sig.verify(hSigVal)};this.parseExt=function(){if(this.version!==3)return-1;var iExtSeq=_getIdxbyList(this.hex,0,[0,7,0],"30");var aExtIdx=_getChildIdx(this.hex,iExtSeq);this.aExtInfo=new Array;for(var i=0;i<aExtIdx.length;i++){var item={};item.critical=false;var a=_getChildIdx(this.hex,aExtIdx[i]);var offset=0;if(a.length===3){item.critical=true;offset=1}item.oid=_ASN1HEX.hextooidstr(_getVbyList(this.hex,aExtIdx[i],[0],"06"));var octidx=_getIdxbyList(this.hex,aExtIdx[i],[1+offset]);item.vidx=_getVidx(this.hex,octidx);this.aExtInfo.push(item)}};this.getExtInfo=function(oidOrName){var a=this.aExtInfo;var oid=oidOrName;if(!oidOrName.match(/^[0-9.]+$/)){oid=KJUR.asn1.x509.OID.name2oid(oidOrName)}if(oid==="")return undefined;for(var i=0;i<a.length;i++){if(a[i].oid===oid)return a[i]}return undefined};this.getExtBasicConstraints=function(){var info=this.getExtInfo("basicConstraints");if(info===undefined)return info;var hBC=_getV(this.hex,info.vidx);if(hBC==="")return{};if(hBC==="0101ff")return{cA:true};if(hBC.substr(0,8)==="0101ff02"){var pathLexHex=_getV(hBC,6);var pathLen=parseInt(pathLexHex,16);return{cA:true,pathLen:pathLen}}throw"basicConstraints parse error"};this.getExtKeyUsageBin=function(){var info=this.getExtInfo("keyUsage");if(info===undefined)return"";var hKeyUsage=_getV(this.hex,info.vidx);if(hKeyUsage.length%2!=0||hKeyUsage.length<=2)throw"malformed key usage value";var unusedBits=parseInt(hKeyUsage.substr(0,2));var bKeyUsage=parseInt(hKeyUsage.substr(2),16).toString(2);return bKeyUsage.substr(0,bKeyUsage.length-unusedBits)};this.getExtKeyUsageString=function(){var bKeyUsage=this.getExtKeyUsageBin();var a=new Array;for(var i=0;i<bKeyUsage.length;i++){if(bKeyUsage.substr(i,1)=="1")a.push(X509.KEYUSAGE_NAME[i])}return a.join(",")};this.getExtSubjectKeyIdentifier=function(){var info=this.getExtInfo("subjectKeyIdentifier");if(info===undefined)return info;return _getV(this.hex,info.vidx)};this.getExtAuthorityKeyIdentifier=function(){var info=this.getExtInfo("authorityKeyIdentifier");if(info===undefined)return info;var result={};var hAKID=_getTLV(this.hex,info.vidx);var a=_getChildIdx(hAKID,0);for(var i=0;i<a.length;i++){if(hAKID.substr(a[i],2)==="80")result.kid=_getV(hAKID,a[i])}return result};this.getExtExtKeyUsageName=function(){var info=this.getExtInfo("extKeyUsage");if(info===undefined)return info;var result=new Array;var h=_getTLV(this.hex,info.vidx);if(h==="")return result;var a=_getChildIdx(h,0);for(var i=0;i<a.length;i++){result.push(_oidname(_getV(h,a[i])))}return result};this.getExtSubjectAltName=function(){var a=this.getExtSubjectAltName2();var result=new Array;for(var i=0;i<a.length;i++){if(a[i][0]==="DNS")result.push(a[i][1])}return result};this.getExtSubjectAltName2=function(){var gnValueHex,gnValueStr,gnTag;var info=this.getExtInfo("subjectAltName");if(info===undefined)return info;var result=new Array;var h=_getTLV(this.hex,info.vidx);var a=_getChildIdx(h,0);for(var i=0;i<a.length;i++){gnTag=h.substr(a[i],2);gnValueHex=_getV(h,a[i]);if(gnTag==="81"){gnValueStr=hextoutf8(gnValueHex);result.push(["MAIL",gnValueStr])}if(gnTag==="82"){gnValueStr=hextoutf8(gnValueHex);result.push(["DNS",gnValueStr])}if(gnTag==="84"){gnValueStr=X509.hex2dn(gnValueHex,0);result.push(["DN",gnValueStr])}if(gnTag==="86"){gnValueStr=hextoutf8(gnValueHex);result.push(["URI",gnValueStr])}if(gnTag==="87"){gnValueStr=hextoip(gnValueHex);result.push(["IP",gnValueStr])}}return result};this.getExtCRLDistributionPointsURI=function(){var info=this.getExtInfo("cRLDistributionPoints");if(info===undefined)return info;var result=new Array;var a=_getChildIdx(this.hex,info.vidx);for(var i=0;i<a.length;i++){try{var hURI=_getVbyList(this.hex,a[i],[0,0,0],"86");var uri=hextoutf8(hURI);result.push(uri)}catch(ex){}}return result};this.getExtAIAInfo=function(){var info=this.getExtInfo("authorityInfoAccess");if(info===undefined)return info;var result={ocsp:[],caissuer:[]};var a=_getChildIdx(this.hex,info.vidx);for(var i=0;i<a.length;i++){var hOID=_getVbyList(this.hex,a[i],[0],"06");var hName=_getVbyList(this.hex,a[i],[1],"86");if(hOID==="2b06010505073001"){result.ocsp.push(hextoutf8(hName))}if(hOID==="2b06010505073002"){result.caissuer.push(hextoutf8(hName))}}return result};this.getExtCertificatePolicies=function(){var info=this.getExtInfo("certificatePolicies");if(info===undefined)return info;var hExt=_getTLV(this.hex,info.vidx);var result=[];var a=_getChildIdx(hExt,0);for(var i=0;i<a.length;i++){var policyInfo={};var a1=_getChildIdx(hExt,a[i]);policyInfo.id=_oidname(_getV(hExt,a1[0]));if(a1.length===2){var a2=_getChildIdx(hExt,a1[1]);for(var j=0;j<a2.length;j++){var hQualifierId=_getVbyList(hExt,a2[j],[0],"06");if(hQualifierId==="2b06010505070201"){policyInfo.cps=hextoutf8(_getVbyList(hExt,a2[j],[1]))}else if(hQualifierId==="2b06010505070202"){policyInfo.unotice=hextoutf8(_getVbyList(hExt,a2[j],[1,0]))}}}result.push(policyInfo)}return result};this.readCertPEM=function(sCertPEM){this.readCertHex(_pemtohex(sCertPEM))};this.readCertHex=function(sCertHex){this.hex=sCertHex;this.getVersion();try{_getIdxbyList(this.hex,0,[0,7],"a3");this.parseExt()}catch(ex){}};this.getInfo=function(){var _X509=X509;var s,pubkey,aExt;s="Basic Fields\n";s+="  serial number: "+this.getSerialNumberHex()+"\n";s+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n";s+="  issuer: "+this.getIssuerString()+"\n";s+="  notBefore: "+this.getNotBefore()+"\n";s+="  notAfter: "+this.getNotAfter()+"\n";s+="  subject: "+this.getSubjectString()+"\n";s+="  subject public key info: "+"\n";pubkey=this.getPublicKey();s+="    key algorithm: "+pubkey.type+"\n";if(pubkey.type==="RSA"){s+="    n="+hextoposhex(pubkey.n.toString(16)).substr(0,16)+"...\n";s+="    e="+hextoposhex(pubkey.e.toString(16))+"\n"}aExt=this.aExtInfo;if(aExt!==undefined&&aExt!==null){s+="X509v3 Extensions:\n";for(var i=0;i<aExt.length;i++){var info=aExt[i];var extName=KJUR.asn1.x509.OID.oid2name(info["oid"]);if(extName==="")extName=info["oid"];var critical="";if(info["critical"]===true)critical="CRITICAL";s+="  "+extName+" "+critical+":\n";if(extName==="basicConstraints"){var bc=this.getExtBasicConstraints();if(bc.cA===undefined){s+="    {}\n"}else{s+="    cA=true";if(bc.pathLen!==undefined)s+=", pathLen="+bc.pathLen;s+="\n"}}else if(extName==="keyUsage"){s+="    "+this.getExtKeyUsageString()+"\n"}else if(extName==="subjectKeyIdentifier"){s+="    "+this.getExtSubjectKeyIdentifier()+"\n"}else if(extName==="authorityKeyIdentifier"){var akid=this.getExtAuthorityKeyIdentifier();if(akid.kid!==undefined)s+="    kid="+akid.kid+"\n"}else if(extName==="extKeyUsage"){var eku=this.getExtExtKeyUsageName();s+="    "+eku.join(", ")+"\n"}else if(extName==="subjectAltName"){var san=this.getExtSubjectAltName2();s+="    "+san+"\n"}else if(extName==="cRLDistributionPoints"){var cdp=this.getExtCRLDistributionPointsURI();s+="    "+cdp+"\n"}else if(extName==="authorityInfoAccess"){var aia=this.getExtAIAInfo();if(aia.ocsp!==undefined)s+="    ocsp: "+aia.ocsp.join(",")+"\n";if(aia.caissuer!==undefined)s+="    caissuer: "+aia.caissuer.join(",")+"\n"}else if(extName==="certificatePolicies"){var aCP=this.getExtCertificatePolicies();for(var j=0;j<aCP.length;j++){if(aCP[j].id!==undefined)s+="    policy oid: "+aCP[j].id+"\n";if(aCP[j].cps!==undefined)s+="    cps: "+aCP[j].cps+"\n"}}}}s+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n";s+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n";return s}}X509.hex2dn=function(hex,idx){if(idx===undefined)idx=0;if(hex.substr(idx,2)!=="30")throw"malformed DN";var a=new Array;var aIdx=ASN1HEX.getChildIdx(hex,idx);for(var i=0;i<aIdx.length;i++){a.push(X509.hex2rdn(hex,aIdx[i]))}a=a.map(function(s){return s.replace("/","\\/")});return"/"+a.join("/")};X509.hex2rdn=function(hex,idx){if(idx===undefined)idx=0;if(hex.substr(idx,2)!=="31")throw"malformed RDN";var a=new Array;var aIdx=ASN1HEX.getChildIdx(hex,idx);for(var i=0;i<aIdx.length;i++){a.push(X509.hex2attrTypeValue(hex,aIdx[i]))}a=a.map(function(s){return s.replace("+","\\+")});return a.join("+")};X509.hex2attrTypeValue=function(hex,idx){var _ASN1HEX=ASN1HEX;var _getV=_ASN1HEX.getV;if(idx===undefined)idx=0;if(hex.substr(idx,2)!=="30")throw"malformed attribute type and value";var aIdx=_ASN1HEX.getChildIdx(hex,idx);if(aIdx.length!==2||hex.substr(aIdx[0],2)!=="06")"malformed attribute type and value";var oidHex=_getV(hex,aIdx[0]);var oidInt=KJUR.asn1.ASN1Util.oidHexToInt(oidHex);var atype=KJUR.asn1.x509.OID.oid2atype(oidInt);var hV=_getV(hex,aIdx[1]);var rawV=hextorstr(hV);return atype+"="+rawV};X509.getPublicKeyFromCertHex=function(h){var x=new X509;x.readCertHex(h);return x.getPublicKey()};X509.getPublicKeyFromCertPEM=function(sCertPEM){var x=new X509;x.readCertPEM(sCertPEM);return x.getPublicKey()};X509.getPublicKeyInfoPropOfCertPEM=function(sCertPEM){var _ASN1HEX=ASN1HEX;var _getVbyList=_ASN1HEX.getVbyList;var result={};var x,hSPKI,pubkey;result.algparam=null;x=new X509;x.readCertPEM(sCertPEM);hSPKI=x.getPublicKeyHex();result.keyhex=_getVbyList(hSPKI,0,[1],"03").substr(2);result.algoid=_getVbyList(hSPKI,0,[0,0],"06");if(result.algoid==="2a8648ce3d0201"){result.algparam=_getVbyList(hSPKI,0,[0,1],"06")}return result};X509.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"];