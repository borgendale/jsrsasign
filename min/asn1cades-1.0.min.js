if(typeof KJUR=="undefined"||!KJUR)KJUR={};if(typeof KJUR.asn1=="undefined"||!KJUR.asn1)KJUR.asn1={};if(typeof KJUR.asn1.cades=="undefined"||!KJUR.asn1.cades)KJUR.asn1.cades={};KJUR.asn1.cades.SignaturePolicyIdentifier=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERObjectIdentifier=_KJUR_asn1.DERObjectIdentifier,_DERSequence=_KJUR_asn1.DERSequence,_KJUR_asn1_cades=_KJUR_asn1.cades,_OtherHashAlgAndValue=_KJUR_asn1_cades.OtherHashAlgAndValue;_KJUR_asn1_cades.SignaturePolicyIdentifier.superclass.constructor.call(this);this.attrTypeOid="1.2.840.113549.1.9.16.2.15";if(params!==undefined){if(typeof params.oid=="string"&&typeof params.hash=="object"){var dOid=new _DERObjectIdentifier({oid:params.oid});var dHash=new _OtherHashAlgAndValue(params.hash);var seq=new _DERSequence({array:[dOid,dHash]});this.valueList=[seq]}}};YAHOO.lang.extend(KJUR.asn1.cades.SignaturePolicyIdentifier,KJUR.asn1.cms.Attribute);KJUR.asn1.cades.OtherHashAlgAndValue=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_DERSequence=_KJUR_asn1.DERSequence,_DEROctetString=_KJUR_asn1.DEROctetString,_KJUR_asn1_x509=_KJUR_asn1.x509,_AlgorithmIdentifier=_KJUR_asn1_x509.AlgorithmIdentifier,_KJUR_asn1_cades=_KJUR_asn1.cades,_OtherHashAlgAndValue=_KJUR_asn1_cades.OtherHashAlgAndValue;_OtherHashAlgAndValue.superclass.constructor.call(this);this.dAlg=null;this.dHash=null;this.getEncodedHex=function(){var seq=new _DERSequence({array:[this.dAlg,this.dHash]});this.hTLV=seq.getEncodedHex();return this.hTLV};if(params!==undefined){if(typeof params.alg=="string"&&typeof params.hash=="string"){this.dAlg=new _AlgorithmIdentifier({name:params.alg});this.dHash=new _DEROctetString({hex:params.hash})}}};YAHOO.lang.extend(KJUR.asn1.cades.OtherHashAlgAndValue,KJUR.asn1.ASN1Object);KJUR.asn1.cades.SignatureTimeStamp=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_ASN1Object=_KJUR_asn1.ASN1Object,_KJUR_asn1_x509=_KJUR_asn1.x509,_KJUR_asn1_cades=_KJUR_asn1.cades;_KJUR_asn1_cades.SignatureTimeStamp.superclass.constructor.call(this);this.attrTypeOid="1.2.840.113549.1.9.16.2.14";this.tstHex=null;if(params!==undefined){if(params.res!==undefined){if(typeof params.res=="string"&&params.res.match(/^[0-9A-Fa-f]+$/)){}else if(params.res instanceof _ASN1Object){}else{throw"res param shall be ASN1Object or hex string"}}if(params.tst!==undefined){if(typeof params.tst=="string"&&params.tst.match(/^[0-9A-Fa-f]+$/)){var d=new _ASN1Object;this.tstHex=params.tst;d.hTLV=this.tstHex;d.getEncodedHex();this.valueList=[d]}else if(params.tst instanceof _ASN1Object){}else{throw"tst param shall be ASN1Object or hex string"}}}};YAHOO.lang.extend(KJUR.asn1.cades.SignatureTimeStamp,KJUR.asn1.cms.Attribute);KJUR.asn1.cades.CompleteCertificateRefs=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_KJUR_asn1_cades=_KJUR_asn1.cades;_KJUR_asn1_cades.CompleteCertificateRefs.superclass.constructor.call(this);this.attrTypeOid="1.2.840.113549.1.9.16.2.21";this.setByArray=function(a){this.valueList=[];for(var i=0;i<a.length;i++){var o=new _KJUR_asn1_cades.OtherCertID(a[i]);this.valueList.push(o)}};if(params!==undefined){if(typeof params=="object"&&typeof params.length=="number"){this.setByArray(params)}}};YAHOO.lang.extend(KJUR.asn1.cades.CompleteCertificateRefs,KJUR.asn1.cms.Attribute);KJUR.asn1.cades.OtherCertID=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_KJUR_asn1_cms=_KJUR_asn1.cms,_KJUR_asn1_cades=_KJUR_asn1.cades;_KJUR_asn1_cades.OtherCertID.superclass.constructor.call(this);this.hasIssuerSerial=true;this.dOtherCertHash=null;this.dIssuerSerial=null;this.setByCertPEM=function(certPEM){this.dOtherCertHash=new _KJUR_asn1_cades.OtherHash(certPEM);if(this.hasIssuerSerial)this.dIssuerSerial=new _KJUR_asn1_cms.IssuerAndSerialNumber(certPEM)};this.getEncodedHex=function(){if(this.hTLV!=null)return this.hTLV;if(this.dOtherCertHash==null)throw"otherCertHash not set";var a=[this.dOtherCertHash];if(this.dIssuerSerial!=null)a.push(this.dIssuerSerial);var seq=new _KJUR_asn1.DERSequence({array:a});this.hTLV=seq.getEncodedHex();return this.hTLV};if(params!==undefined){if(typeof params=="string"&&params.indexOf("-----BEGIN ")!=-1){this.setByCertPEM(params)}if(typeof params=="object"){if(params.hasis===false)this.hasIssuerSerial=false;if(typeof params.cert=="string")this.setByCertPEM(params.cert)}}};YAHOO.lang.extend(KJUR.asn1.cades.OtherCertID,KJUR.asn1.ASN1Object);KJUR.asn1.cades.OtherHash=function(params){var _KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_KJUR_asn1_cms=_KJUR_asn1.cms,_KJUR_asn1_cades=_KJUR_asn1.cades,_OtherHashAlgAndValue=_KJUR_asn1_cades.OtherHashAlgAndValue,_hashHex=_KJUR.crypto.Util.hashHex;_KJUR_asn1_cades.OtherHash.superclass.constructor.call(this);this.alg="sha256";this.dOtherHash=null;this.setByCertPEM=function(certPEM){if(certPEM.indexOf("-----BEGIN ")==-1)throw"certPEM not to seem PEM format";var hex=pemtohex(certPEM);var hash=_hashHex(hex,this.alg);this.dOtherHash=new _OtherHashAlgAndValue({alg:this.alg,hash:hash})};this.getEncodedHex=function(){if(this.dOtherHash==null)throw"OtherHash not set";return this.dOtherHash.getEncodedHex()};if(params!==undefined){if(typeof params=="string"){if(params.indexOf("-----BEGIN ")!=-1){this.setByCertPEM(params)}else if(params.match(/^[0-9A-Fa-f]+$/)){this.dOtherHash=new _KJUR_asn1.DEROctetString({hex:params})}else{throw"unsupported string value for params"}}else if(typeof params=="object"){if(typeof params.cert=="string"){if(typeof params.alg=="string")this.alg=params.alg;this.setByCertPEM(params.cert)}else{this.dOtherHash=new _OtherHashAlgAndValue(params)}}}};YAHOO.lang.extend(KJUR.asn1.cades.OtherHash,KJUR.asn1.ASN1Object);KJUR.asn1.cades.CAdESUtil=new function(){};KJUR.asn1.cades.CAdESUtil.addSigTS=function(dCMS,siIdx,sigTSHex){};KJUR.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(hex){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getTLV=_ASN1HEX.getTLV,_getTLVbyList=_ASN1HEX.getTLVbyList,_getIdxbyList=_ASN1HEX.getIdxbyList,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_ASN1Object=_KJUR_asn1.ASN1Object,_KJUR_asn1_cms=_KJUR_asn1.cms,_SignedData=_KJUR_asn1_cms.SignedData,_KJUR_asn1_cades=_KJUR_asn1.cades,_CAdESUtil=_KJUR_asn1_cades.CAdESUtil;var r={};if(_getTLVbyList(hex,0,[0])!="06092a864886f70d010702")throw"hex is not CMS SignedData";var iSD=_getIdxbyList(hex,0,[1,0]);var aSDChildIdx=_getChildIdx(hex,iSD);if(aSDChildIdx.length<4)throw"num of SignedData elem shall be 4 at least";var iVersion=aSDChildIdx.shift();r.version=_getTLV(hex,iVersion);var iAlgs=aSDChildIdx.shift();r.algs=_getTLV(hex,iAlgs);var iEncapContent=aSDChildIdx.shift();r.encapcontent=_getTLV(hex,iEncapContent);r.certs=null;r.revs=null;r.si=[];var iNext=aSDChildIdx.shift();if(hex.substr(iNext,2)=="a0"){r.certs=_getTLV(hex,iNext);iNext=aSDChildIdx.shift()}if(hex.substr(iNext,2)=="a1"){r.revs=_getTLV(hex,iNext);iNext=aSDChildIdx.shift()}var iSignerInfos=iNext;if(hex.substr(iSignerInfos,2)!="31")throw"Can't find signerInfos";var aSIIndex=_getChildIdx(hex,iSignerInfos);for(var i=0;i<aSIIndex.length;i++){var iSI=aSIIndex[i];var pSI=_CAdESUtil.parseSignerInfoForAddingUnsigned(hex,iSI,i);r.si[i]=pSI}var tmp=null;r.obj=new _SignedData;tmp=new _ASN1Object;tmp.hTLV=r.version;r.obj.dCMSVersion=tmp;tmp=new _ASN1Object;tmp.hTLV=r.algs;r.obj.dDigestAlgs=tmp;tmp=new _ASN1Object;tmp.hTLV=r.encapcontent;r.obj.dEncapContentInfo=tmp;tmp=new _ASN1Object;tmp.hTLV=r.certs;r.obj.dCerts=tmp;r.obj.signerInfoList=[];for(var i=0;i<r.si.length;i++){r.obj.signerInfoList.push(r.si[i].obj)}return r};KJUR.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(hex,iSI,nth){var _ASN1HEX=ASN1HEX,_getChildIdx=_ASN1HEX.getChildIdx,_getTLV=_ASN1HEX.getTLV,_getV=_ASN1HEX.getV,_KJUR=KJUR,_KJUR_asn1=_KJUR.asn1,_ASN1Object=_KJUR_asn1.ASN1Object,_KJUR_asn1_cms=_KJUR_asn1.cms,_AttributeList=_KJUR_asn1_cms.AttributeList,_SignerInfo=_KJUR_asn1_cms.SignerInfo;var r={};var aSIChildIdx=_getChildIdx(hex,iSI);if(aSIChildIdx.length!=6)throw"not supported items for SignerInfo (!=6)";var iVersion=aSIChildIdx.shift();r.version=_getTLV(hex,iVersion);var iIdentifier=aSIChildIdx.shift();r.si=_getTLV(hex,iIdentifier);var iDigestAlg=aSIChildIdx.shift();r.digalg=_getTLV(hex,iDigestAlg);var iSignedAttrs=aSIChildIdx.shift();r.sattrs=_getTLV(hex,iSignedAttrs);var iSigAlg=aSIChildIdx.shift();r.sigalg=_getTLV(hex,iSigAlg);var iSig=aSIChildIdx.shift();r.sig=_getTLV(hex,iSig);r.sigval=_getV(hex,iSig);var tmp=null;r.obj=new _SignerInfo;tmp=new _ASN1Object;tmp.hTLV=r.version;r.obj.dCMSVersion=tmp;tmp=new _ASN1Object;tmp.hTLV=r.si;r.obj.dSignerIdentifier=tmp;tmp=new _ASN1Object;tmp.hTLV=r.digalg;r.obj.dDigestAlgorithm=tmp;tmp=new _ASN1Object;tmp.hTLV=r.sattrs;r.obj.dSignedAttrs=tmp;tmp=new _ASN1Object;tmp.hTLV=r.sigalg;r.obj.dSigAlg=tmp;tmp=new _ASN1Object;tmp.hTLV=r.sig;r.obj.dSig=tmp;r.obj.dUnsignedAttrs=new _AttributeList;return r};